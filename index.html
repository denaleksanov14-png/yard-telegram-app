<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í—ã–±–æ—Ä –æ–∫—Ä—É–≥–∞ –∏ —Ä–∞–π–æ–Ω–∞ –ú–æ—Å–∫–≤—ã</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 25px;
            color: white;
        }
        
        .header h1 {
            font-size: 22px;
            margin-bottom: 8px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .breadcrumb {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            color: white;
            font-size: 14px;
        }
        
        .breadcrumb span {
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.3s;
        }
        
        .breadcrumb span:hover {
            opacity: 1;
        }
        
        .breadcrumb .separator {
            margin: 0 8px;
            opacity: 0.6;
        }
        
        .breadcrumb .current {
            opacity: 1;
            font-weight: 600;
        }
        
        .content-container {
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            min-height: 400px;
        }
        
        .search-box {
            margin-bottom: 15px;
            position: relative;
        }
        
        .search-box input {
            width: 100%;
            padding: 12px 40px 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .search-box input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Å–ø–∏—Å–∫–∞ */
        .district-item, .area-item {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
            border-radius: 10px;
            margin-bottom: 5px;
        }
        
        .district-item:last-child, .area-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .district-item:hover, .area-item:hover {
            background-color: #f8f9fa;
        }
        
        .district-item.selected, .area-item.selected {
            background-color: #e3f2fd;
            border-left: 4px solid #2196f3;
        }
        
        .item-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
            flex-shrink: 0;
            font-size: 18px;
        }
        
        .area-item .item-icon {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            font-size: 16px;
        }
        
        .item-info {
            flex: 1;
        }
        .item-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
            font-size: 15px;
        }
        
        .item-details {
            font-size: 13px;
            color: #666;
        }
        
        .selected-badge {
            color: #2196f3;
            font-size: 18px;
            margin-left: 10px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .selected .selected-badge {
            opacity: 1;
        }
        
        .confirm-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }
        
        .confirm-btn:active {
            transform: scale(0.98);
        }
        
        .confirm-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .selection-info {
            text-align: center;
            margin-top: 15px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 10px;
            color: #666;
            font-size: 14px;
            min-height: 20px;
        }
        
        .no-results {
            text-align: center;
            padding: 30px;
            color: #666;
            font-size: 14px;
        }
        
        /* –ê–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è —Å–º–µ–Ω—ã —à–∞–≥–æ–≤ */
        .step {
            display: none;
        }
        
        .step.active {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 id="mainTitle">üèôÔ∏è –í—ã–±–æ—Ä –æ–∫—Ä—É–≥–∞ –ú–æ—Å–∫–≤—ã</h1>
            <p id="mainSubtitle">–í—ã–±–µ—Ä–∏—Ç–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–π –æ–∫—Ä—É–≥</p>
        </div>
        
        <div class="breadcrumb" id="breadcrumb">
            <span class="current">–û–∫—Ä—É–≥</span>
        </div>
        
        <div class="content-container">
            <!-- –®–∞–≥ 1: –í—ã–±–æ—Ä –æ–∫—Ä—É–≥–∞ -->
            <div class="step active" id="stepDistricts">
                <div class="search-box">
                    <input type="text" id="searchDistricts" placeholder="–ü–æ–∏—Å–∫ –æ–∫—Ä—É–≥–∞..." />
                    <div class="search-icon">üîç</div>
                </div>
                
                <div id="districtsList">
                    <!-- –°–ø–∏—Å–æ–∫ –æ–∫—Ä—É–≥–æ–≤ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –∑–¥–µ—Å—å -->
                </div>
                
                <div class="selection-info" id="districtSelectionInfo">
                    –û–∫—Ä—É–≥ –Ω–µ –≤—ã–±—Ä–∞–Ω
                </div>
            </div>
            
            <!-- –®–∞–≥ 2: –í—ã–±–æ—Ä —Ä–∞–π–æ–Ω–∞ -->
            <div class="step" id="stepAreas">
                <div class="search-box">
                    <input type="text" id="searchAreas" placeholder="–ü–æ–∏—Å–∫ —Ä–∞–π–æ–Ω–∞..." />
                    <div class="search-icon">üîç</div>
                </div>
                
                <div id="areasList">
                    <!-- –°–ø–∏—Å–æ–∫ —Ä–∞–π–æ–Ω–æ–≤ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –∑–¥–µ—Å—å -->
                </div>
                
                <div class="selection-info" id="areaSelectionInfo">
                    –†–∞–π–æ–Ω –Ω–µ –≤—ã–±—Ä–∞–Ω
                </div>
            </div>
        </div>
        
        <button class="confirm-btn" id="confirmBtn" disabled>
            –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–±–æ—Ä
        </button>
    </div>

    <script>
        // –î–∞–Ω–Ω—ã–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã—Ö –æ–∫—Ä—É–≥–æ–≤ –ú–æ—Å–∫–≤—ã —Å —Ä–∞–π–æ–Ω–∞–º–∏
        const moscowData = [
            { 
                id: 1, 
                name: "–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–π –æ–∫—Ä—É–≥", 
                area: "66.2 –∫–º¬≤",
                population: "‚Üó 753 000",
                stations: "25 —Å—Ç–∞–Ω—Ü–∏–π –º–µ—Ç—Ä–æ",
                emoji: "üèõÔ∏è",
                areas: [
                    { id: 101, name: "–ê—Ä–±–∞—Ç", population: "30,200", stations: ["–ê—Ä–±–∞—Ç—Å–∫–∞—è", "–°–º–æ–ª–µ–Ω—Å–∫–∞—è"] },
                    { id: 102, name: "–ë–∞—Å–º–∞–Ω–Ω—ã–π", population: "110,500", stations: ["–ö—É—Ä—Å–∫–∞—è", "–ö—Ä–∞—Å–Ω—ã–µ –í–æ—Ä–æ—Ç–∞"] },
                    { id: 103, name: "–ó–∞–º–æ—Å–∫–≤–æ—Ä–µ—á—å–µ", population: "58,300", stations: ["–¢—Ä–µ—Ç—å—è–∫–æ–≤—Å–∫–∞—è", "–ù–æ–≤–æ–∫—É–∑–Ω–µ—Ü–∫–∞—è"] },
                    { id: 104, name: "–ö—Ä–∞—Å–Ω–æ—Å–µ–ª—å—Å–∫–∏–π", population: "49,800", stations: ["–ö—Ä–∞—Å–Ω–æ—Å–µ–ª—å—Å–∫–∞—è", "–ö–æ–º—Å–æ–º–æ–ª—å—Å–∫–∞—è"] },
                    { id: 105, name: "–ú–µ—â–∞–Ω—Å–∫–∏–π", population: "64,200", stations: ["–ü—Ä–æ—Å–ø–µ–∫—Ç –ú–∏—Ä–∞", "–°—É—Ö–∞—Ä–µ–≤—Å–∫–∞—è"] },
                    { id: 106, name: "–ü—Ä–µ—Å–Ω–µ–Ω—Å–∫–∏–π", population: "128,900", stations: ["–ö—Ä–∞—Å–Ω–æ–ø—Ä–µ—Å–Ω–µ–Ω—Å–∫–∞—è", "–£–ª–∏—Ü–∞ 1905 –≥–æ–¥–∞"] },
                    { id: 107, name: "–¢–∞–≥–∞–Ω—Å–∫–∏–π", population: "121,600", stations: ["–¢–∞–≥–∞–Ω—Å–∫–∞—è", "–ú–∞—Ä–∫—Å–∏—Å—Ç—Å–∫–∞—è"] },
                    { id: 108, name: "–¢–≤–µ—Ä—Å–∫–æ–π", population: "82,800", stations: ["–¢–≤–µ—Ä—Å–∫–∞—è", "–ü—É—à–∫–∏–Ω—Å–∫–∞—è"] },
                    { id: 109, name: "–•–∞–º–æ–≤–Ω–∏–∫–∏", population: "107,400", stations: ["–ü–∞—Ä–∫ –ö—É–ª—å—Ç—É—Ä—ã", "–°–ø–æ—Ä—Ç–∏–≤–Ω–∞—è"] },
                    { id: 110, name: "–Ø–∫–∏–º–∞–Ω–∫–∞", population: "28,900", stations: ["–û–∫—Ç—è–±—Ä—å—Å–∫–∞—è", "–ü–æ–ª—è–Ω–∫–∞"] }
                ]
            },
            { 
                id: 2, 
                name: "–°–µ–≤–µ—Ä–Ω—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–π –æ–∫—Ä—É–≥", 
                area: "113.7 –∫–º¬≤",
                population: "‚Üó 1,125,000",
                stations: "15 —Å—Ç–∞–Ω—Ü–∏–π –º–µ—Ç—Ä–æ",
                emoji: "üå≤",
                areas: [
                    { id: 201, name: "–ê—ç—Ä–æ–ø–æ—Ä—Ç", population: "78,400", stations: ["–ê—ç—Ä–æ–ø–æ—Ä—Ç", "–î–∏–Ω–∞–º–æ"] },
                    { id: 202, name: "–ë–µ–≥–æ–≤–æ–π", population: "46,200", stations: ["–ë–µ–≥–æ–≤–∞—è"] },
                    { id: 203, name: "–ë–µ—Å–∫—É–¥–Ω–∏–∫–æ–≤—Å–∫–∏–π", population: "79,800", stations: ["–í–µ—Ä—Ö–Ω–∏–µ –õ–∏—Ö–æ–±–æ—Ä—ã"] },
                    { id: 204, name: "–í–æ–π–∫–æ–≤—Å–∫–∏–π", population: "71,500", stations: ["–í–æ–π–∫–æ–≤—Å–∫–∞—è"] },
                    { id: 205, name: "–í–æ—Å—Ç–æ—á–Ω–æ–µ –î–µ–≥—É–Ω–∏–Ω–æ", population: "105,300", stations: ["–ü–µ—Ç—Ä–æ–≤—Å–∫–æ-–†–∞–∑—É–º–æ–≤—Å–∫–∞—è"] },
                    { id: 206, name: "–ì–æ–ª–æ–≤–∏–Ω—Å–∫–∏–π", population: "101,600", stations: ["–í–æ–¥–Ω—ã–π —Å—Ç–∞–¥–∏–æ–Ω", "–†–µ—á–Ω–æ–π –≤–æ–∫–∑–∞–ª"] },
                    { id: 207, name: "–î–º–∏—Ç—Ä–æ–≤—Å–∫–∏–π", population: "94,700", stations: ["–î–º–∏—Ç—Ä–æ–≤—Å–∫–∞—è"] },
                    { id: 208, name: "–ó–∞–ø–∞–¥–Ω–æ–µ –î–µ–≥—É–Ω–∏–Ω–æ", population: "82,100", stations: [] },
                    { id: 209, name: "–ö–æ–ø—Ç–µ–≤–æ", population: "103,800", stations: ["–í–æ–π–∫–æ–≤—Å–∫–∞—è"] },
                    { id: 210, name: "–õ–µ–≤–æ–±–µ—Ä–µ–∂–Ω—ã–π", population: "56,300", stations: ["–†–µ—á–Ω–æ–π –≤–æ–∫–∑–∞–ª"] },
                    { id: 211, name: "–ú–æ–ª–∂–∞–Ω–∏–Ω–æ–≤—Å–∫–∏–π", population: "4,500", stations: [] },
                    { id: 212, name: "–°–∞–≤—ë–ª–æ–≤—Å–∫–∏–π", population: "59,800", stations: ["–°–∞–≤—ë–ª–æ–≤—Å–∫–∞—è"] },
                    { id: 213, name: "–°–æ–∫–æ–ª", population: "58,900", stations: ["–°–æ–∫–æ–ª"] },
                    { id: 214, name: "–¢–∏–º–∏—Ä—è–∑–µ–≤—Å–∫–∏–π", population: "81,200", stations: ["–¢–∏–º–∏—Ä—è–∑–µ–≤—Å–∫–∞—è"] },
                    { id: 215, name: "–•–æ–≤—Ä–∏–Ω–æ", population: "91,400", stations: ["–•–æ–≤—Ä–∏–Ω–æ"] },
                    { id: 216, name: "–•–æ—Ä–æ—à—ë–≤—Å–∫–∏–π", population: "68,900", stations: ["–ü–æ–ª–µ–∂–∞–µ–≤—Å–∫–∞—è", "–•–æ—Ä–æ—à—ë–≤—Å–∫–∞—è"] }
                ]
            },
            { 
                id: 3, 
                name: "–°–µ–≤–µ—Ä–æ-–í–æ—Å—Ç–æ—á–Ω—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–π –æ–∫—Ä—É–≥", 
                area: "101.9 –∫–º¬≤",
                population: "‚Üó 1,395,000",
                stations: "13 —Å—Ç–∞–Ω—Ü–∏–π –º–µ—Ç—Ä–æ",
                emoji: "üèòÔ∏è",
                areas: [
                    { id: 301, name: "–ê–ª–µ–∫—Å–µ–µ–≤—Å–∫–∏–π", population: "78,900", stations: ["–ê–ª–µ–∫—Å–µ–µ–≤—Å–∫–∞—è"] },
                    { id: 302, name: "–ê–ª—Ç—É—Ñ—å–µ–≤—Å–∫–∏–π", population: "55,200", stations: ["–ê–ª—Ç—É—Ñ—å–µ–≤–æ"] },
                    { id: 303, name: "–ë–∞–±—É—à–∫–∏–Ω—Å–∫–∏–π", population: "78,500", stations: ["–ë–∞–±—É—à–∫–∏–Ω—Å–∫–∞—è"] },
                    { id: 304, name: "–ë–∏–±–∏—Ä–µ–≤–æ", population: "154,600", stations: ["–ë–∏–±–∏—Ä–µ–≤–æ"] },
                    { id: 305, name: "–ë—É—Ç—ã—Ä—Å–∫–∏–π", population: "69,800", stations: ["–ë—É—Ç—ã—Ä—Å–∫–∞—è"] },
                    { id: 306, name: "–õ–∏–∞–Ω–æ–∑–æ–≤–æ", population: "85,200", stations: ["–õ–∏–∞–Ω–æ–∑–æ–≤–æ"] },
                    { id: 307, name: "–õ–æ—Å–∏–Ω–æ–æ—Å—Ç—Ä–æ–≤—Å–∫–∏–π", population: "78,400", stations: ["–õ–æ—Å–∏–Ω–æ–æ—Å—Ç—Ä–æ–≤—Å–∫–∞—è"] },
                    { id: 308, name: "–ú–∞—Ä—Ñ–∏–Ω–æ", population: "26,300", stations: [] },
                    { id: 309, name: "–ú–∞—Ä—å–∏–Ω–∞ –†–æ—â–∞", population: "68,100", stations: ["–ú–∞—Ä—å–∏–Ω–∞ –†–æ—â–∞"] },
                    { id: 310, name: "–û—Å—Ç–∞–Ω–∫–∏–Ω—Å–∫–∏–π", population: "63,400", stations: ["–í–î–ù–•"] },
                    { id: 311, name: "–û—Ç—Ä–∞–¥–Ω–æ–µ", population: "168,200", stations: ["–û—Ç—Ä–∞–¥–Ω–æ–µ"] },
                    { id: 312, name: "–†–æ—Å—Ç–æ–∫–∏–Ω–æ", population: "41,700", stations: ["–ë–æ—Ç–∞–Ω–∏—á–µ—Å–∫–∏–π —Å–∞–¥"] },
                    { id: 313, name: "–°–≤–∏–±–ª–æ–≤–æ", population: "59,300", stations: ["–°–≤–∏–±–ª–æ–≤–æ"] },
                    { id: 314, name: "–°–µ–≤–µ—Ä–Ω—ã–π", population: "10,500", stations: [] },
                    { id: 315, name: "–°–µ–≤–µ—Ä–Ω–æ–µ –ú–µ–¥–≤–µ–¥–∫–æ–≤–æ", population: "118,500", stations: ["–ú–µ–¥–≤–µ–¥–∫–æ–≤–æ"] },
                    { id: 316, name: "–Æ–∂–Ω–æ–µ –ú–µ–¥–≤–µ–¥–∫–æ–≤–æ", population: "83,400", stations: ["–ë–∞–±—É—à–∫–∏–Ω—Å–∫–∞—è"] },
                    { id: 317, name: "–Ø—Ä–æ—Å–ª–∞–≤—Å–∫–∏–π", population: "91,100", stations: ["–í–î–ù–•"] }
                ]
            }
            // –û—Å—Ç–∞–ª—å–Ω—ã–µ –æ–∫—Ä—É–≥–∏ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ...
        ];

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.enableClosingConfirmation();
        
        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        let currentStep = 'districts';
        let selectedDistrict = null;
        let selectedArea = null;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        function initApp() {
            renderDistricts(moscowData);
            setupEventListeners();
            updateBreadcrumb();
        }

        // –†–µ–Ω–¥–µ—Ä —Å–ø–∏—Å–∫–∞ –æ–∫—Ä—É–≥–æ–≤
        function renderDistricts(districtsToRender) {
            const container = document.getElementById('districtsList');
            
            if (districtsToRender.length === 0) {
                container.innerHTML = '<div class="no-results">–û–∫—Ä—É–≥ –Ω–µ –Ω–∞–π–¥–µ–Ω</div>';
                return;
            }
            
            container.innerHTML = districtsToRender.map(district => `
                <div class="district-item" data-id="${district.id}">
                    <div class="item-icon">${district.emoji}</div>
                    <div class="item-info">
                        <div class="item-name">${district.name}</div>
                        <div class="item-details">
                            ${district.area} ‚Ä¢ ${district.population} ‚Ä¢ ${district.stations}
                        </div>
                    </div>
                    <div class="selected-badge">‚úì</div>
                </div>
            `).join('');
            
            reattachDistrictListeners();
        }

        // –†–µ–Ω–¥–µ—Ä —Å–ø–∏—Å–∫–∞ —Ä–∞–π–æ–Ω–æ–≤
        function renderAreas(areasToRender) {
            const container = document.getElementById('areasList');
            
            if (areasToRender.length === 0) {
                container.innerHTML = '<div class="no-results">–†–∞–π–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω</div>';
                return;
            }
            
            container.innerHTML = areasToRender.map(area => `
                <div class="area-item" data-id="${area.id}">
                    <div class="item-icon">üèòÔ∏è</div>
                    <div class="item-info">
                        <div class="item-name">${area.name}</div>
                        <div class="item-details">
                            –ù–∞—Å–µ–ª–µ–Ω–∏–µ: ${area.population} ‚Ä¢ 
                            –ú–µ—Ç—Ä–æ: ${area.stations.length > 0 ? area.stations.slice(0, 2).join(', ') : '–Ω–µ—Ç'}
                        </div>
                    </div>
                    <div class="selected-badge">‚úì</div>
                </div>
            `).join('');
            
            reattachAreaListeners();
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —à–∞–≥–æ–≤
        function goToStep(step) {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.getElementById(`step${step.charAt(0).toUpperCase() + step.slice(1)}`).classList.add('active');
            currentStep = step;
            updateBreadcrumb();
            updateHeader();
            updateConfirmButton();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ö–ª–µ–±–Ω—ã—Ö –∫—Ä–æ—à–µ–∫
        function updateBreadcrumb() {
            const breadcrumb = document.getElementById('breadcrumb');
            
            if (currentStep === 'districts') {
                breadcrumb.innerHTML = '<span class="current">–û–∫—Ä—É–≥</span>';
            } else {
                breadcrumb.innerHTML = `
                    <span onclick="goToStep('districts')">–û–∫—Ä—É–≥</span>
                    <span class="separator">‚Ä∫</span>
                    <span class="current">${selectedDistrict.name}</span>
                `;
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞
        function updateHeader() {
            const title = document.getElementById('mainTitle');
            const subtitle = document.getElementById('mainSubtitle');
            
            if (currentStep === 'districts') {
                title.textContent = 'üèôÔ∏è –í—ã–±–æ—Ä –æ–∫—Ä—É–≥–∞ –ú–æ—Å–∫–≤—ã';
                subtitle.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–π –æ–∫—Ä—É–≥';
            } else {
                title.textContent = üèòÔ∏è ${selectedDistrict.name};
                subtitle.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–π–æ–Ω';
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
        function updateConfirmButton() {
            const button = document.getElementById('confirmBtn');
            
            if (currentStep === 'districts') {
                button.disabled = !selectedDistrict;
                button.textContent = selectedDistrict ? –í—ã–±—Ä–∞—Ç—å: ${selectedDistrict.name} : '–í—ã–±–µ—Ä–∏—Ç–µ –æ–∫—Ä—É–≥';
            } else {
                button.disabled = !selectedArea;
                button.textContent = selectedArea ? –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å: ${selectedArea.name} : '–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–π–æ–Ω';
            }
        }

        // –í—ã–±–æ—Ä –æ–∫—Ä—É–≥–∞
        function selectDistrict(districtId) {
            selectedDistrict = moscowData.find(d => d.id === districtId);
            document.querySelectorAll('.district-item').forEach(item => {
                item.classList.remove('selected');
            });
            document.querySelector(`.district-item[data-id="${districtId}"]`).classList.add('selected');
            
            document.getElementById('districtSelectionInfo').innerHTML = `
                <strong>–í—ã–±—Ä–∞–Ω:</strong> ${selectedDistrict.name}<br>
                <small>${selectedDistrict.area} ‚Ä¢ ${selectedDistrict.population}</small>
            `;
            
            updateConfirmButton();
            
            // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –≤—ã–±–æ—Ä—É —Ä–∞–π–æ–Ω–∞ —á–µ—Ä–µ–∑ 0.5 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                renderAreas(selectedDistrict.areas);
                goToStep('areas');
                selectedArea = null;
                document.getElementById('areaSelectionInfo').textContent = '–†–∞–π–æ–Ω –Ω–µ –≤—ã–±—Ä–∞–Ω';
            }, 500);
        }

        // –í—ã–±–æ—Ä —Ä–∞–π–æ–Ω–∞
        function selectArea(areaId) {
            selectedArea = selectedDistrict.areas.find(a => a.id === areaId);
            document.querySelectorAll('.area-item').forEach(item => {
                item.classList.remove('selected');
            });
            document.querySelector(`.area-item[data-id="${areaId}"]`).classList.add('selected');
            
            document.getElementById('areaSelectionInfo').innerHTML = `
                <strong>–í—ã–±—Ä–∞–Ω:</strong> ${selectedArea.name}<br>
                <small>–ù–∞—Å–µ–ª–µ–Ω–∏–µ: ${selectedArea.population}</small>
            `;
            
            updateConfirmButton();
        }

        // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞
        function confirmSelection() {
            if (currentStep === 'districts' && selectedDistrict) {
                // –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Ä–∞–π–æ–Ω–∞–º
                renderAreas(selectedDistrict.areas);
                goToStep('areas');
                } else if (currentStep === 'areas' && selectedArea) {
                // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ Telegram
                tg.sendData(JSON.stringify({
                    action: 'moscow_location_selected',
                    district: selectedDistrict,
                    area: selectedArea
                }));
                
                tg.showConfirm(`–í—ã–±–æ—Ä —Å–æ—Ö—Ä–∞–Ω–µ–Ω!\n${selectedDistrict.name}\n${selectedArea.name}`, (confirmed) => {
                    tg.close();
                });
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        function reattachDistrictListeners() {
            document.querySelectorAll('.district-item').forEach(item => {
                item.addEventListener('click', function() {
                    selectDistrict(parseInt(this.dataset.id));
                });
            });
        }

        function reattachAreaListeners() {
            document.querySelectorAll('.area-item').forEach(item => {
                item.addEventListener('click', function() {
                    selectArea(parseInt(this.dataset.id));
                });
            });
        }

        function setupEventListeners() {
            // –ü–æ–∏—Å–∫ –æ–∫—Ä—É–≥–æ–≤
            document.getElementById('searchDistricts').addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                const filtered = moscowData.filter(district => 
                    district.name.toLowerCase().includes(searchTerm)
                );
                renderDistricts(filtered);
            });

            // –ü–æ–∏—Å–∫ —Ä–∞–π–æ–Ω–æ–≤
            document.getElementById('searchAreas').addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                const filtered = selectedDistrict.areas.filter(area => 
                    area.name.toLowerCase().includes(searchTerm)
                );
                renderAreas(filtered);
            });

            // –ö–Ω–æ–ø–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
            document.getElementById('confirmBtn').addEventListener('click', confirmSelection);
        }

        // –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
